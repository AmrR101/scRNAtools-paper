---
title: "Database analysis"
author: "Luke Zappia"
date: '`r Sys.Date()`'
output: html_document
---

Code version: `r system("git log -1 --format=oneline | cut -d' ' -f1", intern = TRUE)`

```{r knitr, include = FALSE}
DOCNAME = "database"
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = TRUE,
                      cache.path     = paste0("cache/", DOCNAME, "/"),
                      cache.comments = TRUE,
                      echo           = FALSE,
                      error          = FALSE,
                      fig.align      = "center",
                      fig.path       = paste0("figures/", DOCNAME, "/"),
                      fig.width      = 10,
                      fig.height     = 8,
                      dev            = c('svg', 'png'),
                      message        = FALSE,
                      warning        = FALSE)
```

```{r libaries}
# Plotting
library("cowplot")
library("RColorBrewer")

# Table
library("knitr")

# Strings
library("stringr")

# JSON
library("jsonlite")

# Tidyverse
library("tidyverse")
```

```{r source, cache = FALSE}

```

```{r palette}
pal <- c(pink = "#EC008C",    # Pink
         blue = "#00ADEF",    # Blue
         green = "#8DC63F",   # Green
         teal = "#00B7C6",    # Teal
         orange = "#F47920",  # Orange
         purple = "#7A52C7")  # Purple
```


Introduction
============

In this file we are going to do some analysis of the entries in 
`single_cell_software.csv` to give us an overview of the tools in the 
`scRNA-tools` database.

```{r load}
tools <- read_csv("../data/single_cell_software.csv",
                  col_types = cols(
                      .default = col_logical(),
                      Name = col_character(),
                      Platform = col_character(),
                      DOI = col_character(),
                      PubDate = col_character(),
                      Code = col_character(),
                      Description = col_character(),
                      License = col_character(),
                      Added = col_date(format = ""),
                      Updated = col_date(format = "")
                  ))

glimpse(tools)
```

Tools over time
===============

The first plot we are going to make will look at the how the number of tools in
the database has changed over time.

```{r plot-date-totals}
totals.plot <- tools %>%
    select(Date = Added, PubDate) %>%
    group_by(Date = as.Date(Date)) %>%
    summarise(Count = n(), PubCount = sum(!is.na(PubDate))) %>%
    mutate(Total = cumsum(Count)) %>%
    ggplot(aes(x = Date, y = Total)) +
    geom_line(size = 2, colour = pal["purple"]) +
    xlab("Date") +
    ylab("Number of tools") +
    ggtitle("Increase in tools over time") +
    theme_cowplot() +
    theme(plot.title = element_text(size = 20),
          axis.text = element_text(size = 12)
    )

totals.plot
```

Publication status
==================

Next we will look at the current publication status of the tools in the
database.

```{r, plot-pub-status}
pub.plot <- tools %>%
    select(PubDate) %>%
    mutate(IsPre = PubDate == "PREPRINT") %>%
    mutate(IsPub = !is.na(PubDate) & !IsPre) %>%
    mutate(IsNot = is.na(PubDate)) %>%
    summarise(NotPublished = sum(IsNot),
              Published = sum(IsPub, na.rm = TRUE),
              Preprint = sum(IsPre, na.rm = TRUE)) %>%
    gather(key = Type, value = Count) %>%
    mutate(Type = factor(Type,
                         levels = c("Preprint", "Published", "NotPublished"),
                         labels = c("Preprint", "Published", "Not Published")),
           Cumulative = cumsum(Count),
           Midpoint = Cumulative - (Count / 2),
           Label = paste0(Type, "\n",
                          round(Count / sum(Count) * 100, 1), "%")) %>%
    ggplot(aes(x = 1, weight = Count, fill = Type)) +
    geom_bar(width = 1, position = "stack") +
    coord_polar(theta = "y") +
    geom_text(aes(x = 1.8, y = Midpoint, label = Label, colour = Type),
              size = 6) +
    scale_fill_manual(values = unname(pal)) +
    scale_colour_manual(values = unname(pal)) +
    ggtitle("Publication status") +
    theme_nothing() +
    theme(plot.title = element_text(size = 20),
          legend.position = "none"
    )

pub.plot
```

Licenses
========

We can produce a similar plot of the licenses that are used.

```{r plot-licenses}
license.plot <- tools %>%
    select(License) %>%
    mutate(IsGPL = str_detect(License, "GPL"),
           IsBSD = str_detect(License, "BSD"),
           IsMIT = str_detect(License, "MIT"),
           IsApache = str_detect(License, "Apache"),
           IsArtistic = str_detect(License, "Artistic"),
           IsUnknown = is.na(License),
           IsOther = !(IsGPL | IsBSD | IsMIT | IsApache | IsArtistic | 
                           IsUnknown)) %>%
    summarise(Apache = sum(IsApache, na.rm = TRUE),
              Artistic = sum(IsArtistic, na.rm = TRUE),
              BSD = sum(IsBSD, na.rm = TRUE),
              GPL = sum(IsGPL, na.rm = TRUE),
              MIT = sum(IsMIT, na.rm = TRUE),
              Other = sum(IsOther),
              Unknown = sum(IsUnknown)) %>%
    gather(key = License, value = Count) %>%
    mutate(License = factor(License,
                            levels = c("Apache", "Artistic", "BSD", "GPL",
                                       "MIT", "Other", "Unknown")),
           Cumulative = cumsum(Count),
           Midpoint = Cumulative - (Count / 2),
           Label = paste0(License, "\n",
                          round(Count / sum(Count) * 100, 1), "%")) %>%
    ggplot(aes(x = 1, weight = Count, fill = License)) +
    geom_bar(width = 1, position = "stack") +
    coord_polar(theta = "y") +
    geom_text(aes(x = 1.75, y = nrow(tools) - Midpoint, label = Label,
                  colour = License), size = 6) +
    scale_fill_manual(values = c(unname(pal), "#999999")) +
    scale_colour_manual(values = c(unname(pal), "#999999")) +
    ggtitle("Software licenses") +
    theme_nothing() +
    theme(plot.title = element_text(size = 20),
          legend.position = "none"
    )

license.plot
```

Platforms
=========

Another thing we are interested in is which programming languages/platforms each
of the tools use.

```{r plot-platforms}
platforms.plot <- tools %>%
    select(Platform) %>%
    mutate(IsR = str_detect(Platform, "R"),
           IsPython = str_detect(Platform, "Python"),
           IsMATLAB = str_detect(Platform, "MATLAB"),
           IsCPP = str_detect(Platform, "C++"),
           IsOther = !(IsR | IsPython | IsMATLAB | IsCPP)) %>%
    summarise(R = sum(IsR),
              Python = sum(IsPython),
              MATLAB = sum(IsMATLAB),
              CPP = sum(IsCPP),
              Other = sum(IsOther)) %>%
    gather(key = Platform, value = Count) %>%
    mutate(Platform = factor(Platform,
                             levels = c("R", "Python", "MATLAB", "CPP",
                                        "Other"),
                             labels = c("R", "Python", "MATLAB", "C++",
                                        "Other"))) %>%
    ggplot(aes(x = Platform, weight = Count, fill = Platform)) +
    geom_bar(aes(y = (..count..) / sum(..count..))) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = unname(pal)) +
    ylab("Percentage of tools") +
    ggtitle("Platforms used by analysis tools") +
    theme_cowplot() +
    theme(axis.title.x = element_blank(),
          legend.position = "none",
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12)
    )

platforms.plot
```

Categories
==========

The biggest part of the scRNA-tools database is categorising the tools based on
what they can do. Before we plot anything let's make a table showing the
categories and their descriptions.

```{r categories}
cats <- read_json("../data/descriptions.json", simplifyVector = TRUE) %>%
    mutate(Phase = factor(Phase,
                          levels = c("Phase 1", "Phase 2", "Phase 3", "Phase 4",
                                     "Multiple", "Other")))

cats %>%
    mutate(Category = str_replace_all(Category, "([[:upper:]])", " \\1")) %>%
    arrange(Phase) %>%
    select(Phase, everything()) %>%
    kable()
```

This plot will show the percentage of tools that fall into each category.

```{r plot-categories}
phase.cols <- c(brewer.pal(5, "Set1"), "#999999")

cat.counts <- tools %>%
    summarise_at(8:35, sum) %>%
    gather(key = Category, value = Count) %>%
    arrange(-Count) %>%
    left_join(cats, by = "Category") %>%
    mutate(Category = str_replace_all(Category, "([[:upper:]])", " \\1")) %>%
    mutate(Category = str_trim(Category)) %>%
    mutate(Category = factor(Category, levels = Category))

cats.plot <- ggplot(cat.counts,
                    aes(x = Category, weight = Count, fill = Phase)) +
    geom_bar(aes(y = (..count..) / sum(..count..))) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = phase.cols) +
    ylab("Percentage of tools") +
    ggtitle("Analysis categories") +
    theme_cowplot() +
    theme(axis.title.x = element_blank(),
          legend.position = "right",
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          legend.key.size = unit(25, "points"),
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
    )

cats.plot
```

We can also look at the number of categories per tool.

```{r plot-cats-tool}
cats.tools.plot <- tools %>%
    select(Name, 8:35) %>%
    gather(key = Category, value = TF, -Name) %>%
    group_by(Name) %>%
    summarise(Count = sum(TF)) %>%
    ggplot(aes(x = factor(Count, levels = 1:14))) +
    geom_bar(fill = pal["purple"]) +
    scale_x_discrete(drop = FALSE) +
    ggtitle("Number of categories per tool") +
    xlab("Number of categories") +
    ylab("Number of tools") +
    theme_cowplot() +
    theme(plot.title = element_text(size = 20),
          axis.text = element_text(size = 12)
    )

cats.tools.plot
```

Panel
=====

Now let's put all the plots together into a panel.

```{r make-panel, fig.height = 14}
sub1 <- plot_grid(totals.plot, pub.plot, nrow = 1, ncol = 2,
                  labels = c("A", "B"))
sub2 <- plot_grid(license.plot, platforms.plot, nrow = 1, ncol = 2,
                  labels = c("C", "D"))
sub3 <- plot_grid(cats.plot, nrow = 1, ncol = 1, labels = c("E"))
sub4 <- plot_grid(cats.tools.plot, nrow = 1, ncol = 1, labels = c("F"))

panel <- plot_grid(sub1, sub2, sub3, sub4, nrow = 4, ncol = 1)

panel

save_plot("../figures/analysis_panel.png", panel, ncol = 2, nrow = 3,
          base_height = 6)
save_plot("../figures/analysis_panel.pdf", panel, ncol = 2, nrow = 3,
          base_height = 6)
```

Then vs now
===========

We are also interested in how the database have changed over time.

```{r subset-tools}
tools <- tools %>%
    mutate(IsOld = Added < "2016-10-01")
```

```{r, plot-pub-status-time}
pub.plot.time <- tools %>%
    group_by(IsOld) %>%
    select(PubDate, IsOld) %>%
    mutate(IsPre = PubDate == "PREPRINT") %>%
    mutate(IsPub = !is.na(PubDate) & !IsPre) %>%
    mutate(IsNot = is.na(PubDate)) %>%
    summarise(NotPublished = sum(IsNot),
              Published = sum(IsPub, na.rm = TRUE),
              Preprint = sum(IsPre, na.rm = TRUE)) %>%
    gather(key = Type, value = Count, -IsOld) %>%
    group_by(IsOld) %>%
    mutate(Prop = Count / sum(Count)) %>%
    mutate(Type = factor(Type,
                         levels = c("Preprint", "Published", "NotPublished"),
                         labels = c("Preprint", "Published", "Not Published"))) %>%
    ggplot(aes(x = Type, y = Prop, fill = IsOld)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(name = "Date added",
                      labels = c("After 2016-10-01", "Before 2016-10-01"),
                      values = unname(pal)) +
    scale_y_continuous(labels = scales::percent) +
    ggtitle("Publication status") +
    ylab("Percentage of tools") +
    theme_cowplot() +
    theme(legend.position = c(0.75, 0.85),
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          legend.key.size = unit(25, "points"),
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12),
          axis.title.x = element_blank()
    )

pub.plot.time
```

```{r plot-licenses-time}
license.plot.time <- tools %>%
    group_by(IsOld) %>%
    select(License, IsOld) %>%
    mutate(IsGPL = str_detect(License, "GPL"),
           IsBSD = str_detect(License, "BSD"),
           IsMIT = str_detect(License, "MIT"),
           IsApache = str_detect(License, "Apache"),
           IsArtistic = str_detect(License, "Artistic"),
           IsUnknown = is.na(License),
           IsOther = !(IsGPL | IsBSD | IsMIT | IsApache | IsArtistic | 
                           IsUnknown)) %>%
    summarise(Apache = sum(IsApache, na.rm = TRUE),
              Artistic = sum(IsArtistic, na.rm = TRUE),
              BSD = sum(IsBSD, na.rm = TRUE),
              GPL = sum(IsGPL, na.rm = TRUE),
              MIT = sum(IsMIT, na.rm = TRUE),
              Other = sum(IsOther),
              Unknown = sum(IsUnknown)) %>%
    gather(key = License, value = Count, -IsOld) %>%
    mutate(License = factor(License,
                            levels = c("Apache", "Artistic", "BSD", "GPL",
                                       "MIT", "Other", "Unknown"))) %>%
    group_by(IsOld) %>%
    mutate(Prop = Count / sum(Count)) %>%
    ggplot(aes(x = License, y = Prop, fill = IsOld)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(name = "Date added",
                      labels = c("After 2016-10-01", "Before 2016-10-01"),
                      values = unname(pal)) +
    scale_y_continuous(labels = scales::percent) +
    ggtitle("Software licenses") +
    ylab("Percentage of tools") +
    theme_cowplot() +
    theme(legend.position = c(0.75, 0.85),
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          legend.key.size = unit(25, "points"),
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12),
          axis.title.x = element_blank()
    )

license.plot.time
```

```{r plot-platforms-time}
platforms.plot.time <- tools %>%
    group_by(IsOld) %>%
    select(Platform, IsOld) %>%
    mutate(IsR = str_detect(Platform, "R"),
           IsPython = str_detect(Platform, "Python"),
           IsMATLAB = str_detect(Platform, "MATLAB"),
           IsCPP = str_detect(Platform, "C++"),
           IsOther = !(IsR | IsPython | IsMATLAB | IsCPP)) %>%
    summarise(R = sum(IsR),
              Python = sum(IsPython),
              MATLAB = sum(IsMATLAB),
              CPP = sum(IsCPP),
              Other = sum(IsOther)) %>%
    gather(key = Platform, value = Count, -IsOld) %>%
    mutate(Platform = factor(Platform,
                             levels = c("R", "Python", "MATLAB", "CPP",
                                        "Other"),
                             labels = c("R", "Python", "MATLAB", "C++",
                                        "Other"))) %>%
    group_by(IsOld) %>%
    mutate(Prop = Count / sum(Count)) %>%
    ggplot(aes(x = Platform, weight = Prop, fill = IsOld)) +
    geom_bar(position = "dodge") +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(name = "Date added",
                      labels = c("After 2016-10-01", "Before 2016-10-01"),
                      values = unname(pal)) +
    ggtitle("Platforms used by analysis tools") +
    ylab("Percentage of tools") +
    theme_cowplot() +
    theme(legend.position = c(0.75, 0.85),
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          legend.key.size = unit(25, "points"),
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12),
          axis.title.x = element_blank()
    )

platforms.plot.time
```

```{r plot-categories-time}
cats.time.plot <- tools %>%
    group_by(IsOld) %>%
    summarise_at(8:35, sum) %>%
    gather(key = Category, value = Count, -IsOld) %>%
    mutate(Category = str_replace_all(Category, "([[:upper:]])", " \\1")) %>%
    mutate(Category = str_trim(Category)) %>%
    mutate(Category = factor(Category,
                             levels = rev(levels(cat.counts$Category)))) %>%
    group_by(IsOld) %>%
    mutate(Prop = Count / sum(Count)) %>%
    ggplot(aes(x = Category, y = Prop, colour = IsOld)) +
    geom_point(size = 4) +
    scale_color_manual(name = "Date added",
                       labels = c("After 2016-10-01", "Before 2016-10-01"),
                       values = unname(pal)) +
    scale_y_continuous(labels = scales::percent) +
    coord_flip() +
    ylab("Percentage of tools") +
    ggtitle("Analysis categories") +
    theme_cowplot() +
    theme(axis.title.y = element_blank(),
          legend.position = c(0.7, 0.2),
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          legend.key.size = unit(25, "points"),
          plot.title = element_text(size = 20),
          axis.text = element_text(size = 12)
    )

cats.time.plot
```

```{r plot-cats-tool-time}
cats.tools.time.plot <- tools %>%
    select(Name, IsOld, 8:35) %>%
    gather(key = Category, value = TF, -Name, -IsOld) %>%
    group_by(Name, IsOld) %>%
    summarise(Cats = sum(TF)) %>%
    ungroup() %>%
    select(-Name) %>%
    group_by(IsOld, Cats) %>%
    mutate(Count = n()) %>%
    unique() %>%
    group_by(IsOld) %>%
    mutate(Prop = Count / sum(Count)) %>%
    ggplot(aes(x = factor(Cats, levels = 1:14), y = Prop, fill = IsOld)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(name = "Date added",
                      labels = c("After 2016-10-01", "Before 2016-10-01"),
                      values = unname(pal)) +
    scale_y_continuous(labels = scales::percent) +
    ggtitle("Categories per tool") +
    xlab("Number of categories") +
    ylab("Percentage of tools") +
    theme_cowplot() +
    theme(plot.title = element_text(size = 20),
          axis.text = element_text(size = 12),
          legend.position = c(0.7, 0.7)
    )

cats.tools.time.plot
```

Session info
============

```{r session-info, cache = FALSE}
devtools::session_info()
```
